<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/jquery.Z80-mem.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmeditor.html">asmeditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#refresh">refresh</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmlist.html">asmlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#clearCurrentAddr">clearCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#createAsmRow">createAsmRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#createList">createList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#indexOfAddr">indexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#lastLineIndexOfAddr">lastLineIndexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#listTopIndex">listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#setCurrentAddr">setCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#showCurrentAddr">showCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#updateBreakpoints">updateBreakpoints</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#writeList">writeList</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.html">mz700cg</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#.tableIndex">tableIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#createFontTable">createFontTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#initFont">initFont</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#setPattern">setPattern</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.FontImage.html">FontImage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tabview.html">tabview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#.tabId">tabId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#caption">caption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#currentPage">currentPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#index">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#page">page</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#show">show</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80.html">Z80</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#disassemble">disassemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.dasm">dasm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.processAddressReference">processAddressReference</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80_assemble.html">Z80_assemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#getMap">getMap</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80LineAssembler.html">Z80LineAssembler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getLastAddress">getLastAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getNextAddress">getNextAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#resolveAddress">resolveAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setAddress">setAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setComment">setComment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setLabel">setLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setRefAddrTo">setRefAddrTo</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#easing">easing</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/jquery.Z80-mem.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(function() {
    var $ = require("jquery");
    var jquery_plugin_class = require("../lib/jquery_plugin_class");
    var Z80_assemble = require("../Z80/assembler.js");
    var easing = require("../lib/easing.js");

    jquery_plugin_class("dumplist");
    var dumplist = function(element) {
        this.element = element;
        this.opt = {
            "readMemory" : null,
            "cols" : 16,
            "rows" : 16,
            "_topAddr" : 0,
            "fontFamily" : 'monospace',
            "fontSize" : '4pt',
            "rowHeight" : '14px',
            "colWidth" : '16px',
            "headerWidth" : '30px',
            "getRegValue" : function() {}
        };
        this._charViewAscii = true;
    };
    window.dumplist = dumplist;
    dumplist.charViewForeColor = 0;
    dumplist.charViewBackColor = 7;
    dumplist.charViewAttr =
        (dumplist.charViewForeColor &lt;&lt; 4) |
        dumplist.charViewBackColor;
    dumplist.mz700CharSizePx = 10;
    dumplist.prototype.init = function(opt) {
        if(opt) {
            Object.keys(this.opt).forEach(function(key) {
                if(key in opt) { this.opt[key] = opt[key]; }
            }, this);
        }
        var $root = $("&lt;div/>");
        $root.insertBefore($(this.element));
        $(this.element).appendTo($root);

        var $container = $(this.element);
        $container.empty()
            .css('font-family', this.opt.fontFamily)
            .css('font-size', this.opt.fontSize)
            .css("border-bottom","solid 1px gray");
        var $buttons = $("&lt;div/>");
        $container.append($buttons);
        var $row = $("&lt;div/>").addClass("row").addClass("header")
            .css('height', this.opt.rowHeight)
            .css('line-height', this.opt.rowHeight)
            .css("border-bottom","solid 1px gray");
        $container.append($row);

        var $col = $("&lt;span/>")
            .addClass("cell").addClass("header")
            .css('display','inline-block')
            .css('width', this.opt.headerWidth)
            .css('text-align', "center")
            .css('vertical-align', "top")
            .html("ADDR");
        $row.append($col);
        
        for(var col = 0; col &lt; this.opt.cols; col++) {
            $col = $("&lt;span/>")
                .addClass("cell").addClass("c" + col)
                .css('display','inline-block')
                .css('width', this.opt.colWidth)
                .css('text-align', "center")
                .css('vertical-align', "top");
            $col.html('+' + col.HEX(1));
            $row.append($col);
        }
        let changeCharViewToAscii = showAscii => {
            if(this._charViewAscii != showAscii) {
                this._charViewAscii = showAscii;
                this.redraw();
            }
        };
        $row.append(
            $("&lt;input/>").attr("type", "radio").attr("name","charViewCode")
            .click(()=>{ changeCharViewToAscii(true); })
            .attr("checked", true))
        .append($("&lt;label/>").html("ASCII CODE").css('vertical-align', "top"))
        .append($("&lt;span/>").html("/").css('vertical-align', "top"))
        .append(
            $("&lt;input/>").attr("type", "radio").attr("name","charViewCode")
            .click(()=>{ changeCharViewToAscii(false); }))
        .append($("&lt;label/>").html("DISP.CODE").css('vertical-align', "top"));

        this._topAddr = this.opt._topAddr;
        this.addrCols = [];
        this.dataCells = [];
        let rowWidth = this.opt.headerWidth +
            this.opt.colWidth * this.opt.cols +
            this.opt.colWidth * dumplist.mz700CharSizePx + 10;
        this._charViewRows = [];
        for(var row = 0; row &lt; this.opt.rows; row++) {
            $row = $("&lt;div/>")
                .addClass("row").addClass("r" + row)
                .css('width', rowWidth)
                .css('height', this.opt.rowHeight)
                .css('line-height', this.opt.rowHeight);
            $container.append($row);

            $col = $("&lt;span/>")
                .addClass("cell").addClass("header")
                .css('display','inline-block')
                .css('width', this.opt.headerWidth)
                .css('text-align', "center");

            $row.append($col);
            this.addrCols.push($col);

            //
            // Create all columns
            //
            for(col = 0; col &lt; this.opt.cols; col++) {
                $col = $("&lt;span/>")
                    .addClass("cell").addClass("c" + col)
                    .css('display','inline-block')
                    .css('width', this.opt.colWidth)
                    .css('text-align', "center")
                    .css('vertical-align', "top");
                this.dataCells.push($col);
                $row.append($col);
            }
            let charViewRow = $("&lt;span/>").mz700scrn("create", {
                cols: this.opt.cols, rows:1,
                color: dumplist.charViewForeColor,
                backgroundColor: dumplist.charViewBackColor,
                width: (this.opt.cols * dumplist.mz700CharSizePx) + "px",
                alt:"", title:""
            }).mz700scrn("clear")
                .css("width", this.opt.cols * dumplist.mz700CharSizePx)
                .css("height", dumplist.mz700CharSizePx)
                .css("margin-left", "10px")
                .css("padding-top", "1px")
                .css("display", "inline-block");
            $row.append(charViewRow);
            this._charViewRows.push(charViewRow);
        }

        // Set up event listeners
        this.setupEventListener($container.get(0));

        //
        // 16ビットレジスタが指すアドレスを表示するボタン
        //
        [
            {"H":"B","L": "C"},
            {"H":"D","L": "E"},
            {"H":"H","L": "L"},
            "PC", "SP", "IX", "IY"
        ].forEach(function(regs) {
            var pair = ((typeof(regs) == "string") ? false : true);
            var name16 = (pair ? regs.H + regs.L : regs);
            var getRegValue = (pair ?
                function(regs, callback) {
                    opt.getReg(regs.H, function(value_h) {
                        opt.getReg(regs.L, function(value_l) {
                            callback(value_h * 256 + value_l);
                        });
                    });
                } :
                function(regs, callback) {
                    opt.getReg(regs, callback);
                });
            $buttons
                .append($("&lt;button/>")
                    .attr("id", "btnShowMem" + name16)
                    .attr("type", "button").css("width", "50px").html(name16)
                    .click(function() {
                        getRegValue(regs, function(value) {
                            $("#txtShowMemAddr").val(value.HEX(4) + "H");
                            this.topAddr(value);
                        }.bind(this));
                    }.bind(this)));
        }, this);

        //
        // 指定アドレスを表示するテキストボックスとボタン
        //
        $buttons
            .append($("&lt;input/>")
                    .attr("id", "txtShowMemAddr").attr("type", "text")
                    .attr("value", "0000h").css("width", "80px")
                    .attr("title",
                        "16進数(最後にhまたはH)の他、プログラム中のラベルも使えます。"
                        + "10進数、8進数(0から始まる数字)もOK"))
            .append($("&lt;button/>")
                .attr("id", "btnShowMemAddr")
                .attr("type", "button").css("width", "80px").html("表示更新")
                .click(function() {
                    var addrToken = $("#txtShowMemAddr").val();
                    var asm = new Z80_assemble();
                    var addr = asm.parseAddress(addrToken);
                    if(addr != null) {
                        this.topAddr(addr);
                    }
                }.bind(this)));
        
        this.redraw();
    };

    dumplist.prototype.setReadMemoryHandler = function(handler) {
        this.readMemory = handler;
        this.redraw();
    }

    /**
     * Setup event listener.
     * @param {HTMLElement} dispatcher the event dispatcher
     * @returns {undefined}
     */
    dumplist.prototype.setupEventListener = function(dispatcher) {

        // Scroll by mouse wheel.
        dispatcher.addEventListener("wheel", e => {
            let prevIndex = this._topAddr;
            let topColMod = this._topAddr % this.opt.cols;

            if(e.deltaY &lt; 0) {
                // Scroll up
                let addr = this._topAddr - this.opt.cols;
                if(addr &lt; 0) {
                    addr = topColMod;
                }
                this.topAddr(addr);
            } else if(e.deltaY > 0) {
                // Scroll down
                let addr = this._topAddr + this.opt.cols;
                if(addr >= 65536) {
                    addr = (65536 - this.opt.cols) + topColMod;
                }
                this.topAddr(addr);
            }
            if(prevIndex != this.__topAddr) {
                e.cancelBubble = true;
            } else {
                e.cancelBubble = false;
            }
        });
    };

    /**
     * Set top address and redraw.
     * @param {undefined|number} topAddr address to show. range: 0 to 65535.
     * @returns {number|undefined} top address
     */
    dumplist.prototype.topAddr = function(topAddr) {
        if(topAddr == null) {
            return this._topAddr;
        }
        this._topAddr = topAddr;
        $("#txtShowMemAddr").val(this._topAddr.HEX(4) + "H");
        this.redraw();
    };

    /**
     * Redraw dumplist.
     *
     * @returns {undefined}
     */
    dumplist.prototype.redraw = function() {

        // Calculate address at top-left
        var addr = this._topAddr - (this._topAddr % this.opt.cols) - 7 * this.opt.cols;
        let ulim = 65536 - this.opt.cols * this.opt.rows;
        if(addr > ulim) { addr = ulim; }
        if(addr &lt; 0) { addr = 0; }

        // Change background color of target cell
        let targetIndex = this._topAddr - addr;
        let targetCell = this.dataCells[targetIndex];
        let rgb = (r,g,b) => "rgb(" + [r,g,b].join(",") + ")";
        let easingHandle = null;
        let appealTargetCell = () => {
            if(easingHandle != null) {
                easing.cancel(easingHandle);
            }
            easing(0, 255, 3000, value => {
                targetCell.css("background-color",
                    rgb(255, 255, Math.floor(value)));
            });
        };

        var cellIndex = 0;
        for(var row = 0; row &lt; this.opt.rows; row++) {
            this.addrCols[row].html(addr.HEX(4));
            for(var col = 0; col &lt; this.opt.cols; col++) {
                if(this.readMemory == null) {
                    this.dataCells[cellIndex].html('**');
                } else {
                    this.readMemory(addr,
                            (function(THIS, index, row, col) {
                                return function(value) {
                                    THIS.dataCells[index].html(value.HEX(2));
                                    if(THIS._charViewAscii) {
                                        value = window.mz700scrn.ascii2dispcode[value];
                                    }
                                    THIS._charViewRows[row].mz700scrn(
                                        "writeVram", col, dumplist.charViewAttr, value);

                                    // Change background color of target cell
                                    if(targetIndex == index) {
                                        appealTargetCell();
                                    }
                                };
                            }(this, cellIndex, row, col)));
                }
                addr++;
                cellIndex++;
            }
        }
    };
    dumplist.prototype.updateAt = function(address, value) {
        var cellIndex = address - this._topAddr;
        if(0 &lt;= cellIndex &amp;&amp; cellIndex &lt; this.opt.rows * 16) {
            this.dataCells[cellIndex].html(value.HEX(2));
        }
    };
}());
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Apr 02 2018 22:17:31 GMT+0900 (東京 (標準時)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
