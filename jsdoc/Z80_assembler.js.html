<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Z80/assembler.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmeditor.html">asmeditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#refresh">refresh</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmlist.html">asmlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#clearCurrentAddr">clearCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#indexOfAddr">indexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#lastLineIndexOfAddr">lastLineIndexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#setCurrentAddr">setCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#writeList">writeList</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="AsmRow.html">AsmRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AsmRow.html#.selectorByAddress">selectorByAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="dumplist.html">dumplist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#redraw">redraw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#topAddr">topAddr</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.html">mz700cg</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#.tableIndex">tableIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#createFontTable">createFontTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#initFont">initFont</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#setPattern">setPattern</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.FontImage.html">FontImage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tabview.html">tabview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#.tabId">tabId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#caption">caption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#currentPage">currentPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#index">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#page">page</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#show">show</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="vscrlist.html">vscrlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#_listTopIndex">_listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#countKeyRepeat">countKeyRepeat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#createList">createList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#empty">empty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#flashBufferedKeys">flashBufferedKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#isEmpty">isEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#items">items</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#listTopIndex">listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#reportKbEvent">reportKbEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scroll">scroll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scrollByKeyCode">scrollByKeyCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#setupKeyEventListener">setupKeyEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#syncScrollTop">syncScrollTop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#visibleRows">visibleRows</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80.html">Z80</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#disassemble">disassemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.dasm">dasm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.processAddressReference">processAddressReference</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80_assemble.html">Z80_assemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.assemble">assemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.createMachineCode">createMachineCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.hasExplicitAddress">hasExplicitAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.hashMapArray">hashMapArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.measureCodeSize">measureCodeSize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.resolveAddress">resolveAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#closeAssembling">closeAssembling</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#getMap">getMap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#isAddressExplicit">isAddressExplicit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#parseAddress">parseAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html">Z80AddressSpecifier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html#create">create</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80LineAssembler.html">Z80LineAssembler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.convertToAsciiCode">convertToAsciiCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.getBytecodesFromOperandOfDEFB">getBytecodesFromOperandOfDEFB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.joinOperand">joinOperand</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getLastAddress">getLastAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getNextAddress">getNextAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#resolveAddress">resolveAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setAddress">setAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setComment">setComment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setLabel">setLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setRefAddrTo">setRefAddrTo</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#doLater">doLater</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#easing">easing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEventCode">getEventCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#match_token">match_token</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Z80/assembler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Z80 assembler class.
 */
var Z80LineAssembler = require("./z80-line-assembler");
const parseAddress = require("../lib/parse-addr.js");

/**
 * Z80 Assembler
 *
 * @constructor
 *
 * @param {string} asm_source The source code
 *
 * @param {boolean|undefined} assembleOnly
 * Set true not to resolve the addresses and create machine code.
 *
 * @param {number} startAddr
 * The starting address of assembling.
 */
var Z80_assemble = function(asm_source, assembleOnly, startAddr) {

    if(asm_source == undefined) {
        return;
    }

    /**
     * Assemble result lines
     * @type {object[]}
     */
    this.list = [];
    /**
     * mapping labels to address
     * @type {object}
     */
    this.label2value = {};

    // Assemble the line by line
    let address = startAddr || 0;
    let source_lines = asm_source.split(/\r{0,1}\n/);
    source_lines.forEach( line => {
        let assembled_code = Z80LineAssembler.assemble(
                line, address, this.label2value);
        address = assembled_code.getNextAddress();
        this.list.push(assembled_code);
    });

    /**
     * The list has ORG mnemonic, or not.
     * @type {boolean}
     */
    this._explicitAddress = Z80_assemble.hasExplicitAddress(this.list);

    /**
     * A first address of this assembled codes.
     * @type {number}
     */
    this.min_addr = null;

    /**
     * A last address of this assembled codes.
     * @type {number}
     */
    this.max_addr = null;

    if(assembleOnly) { // Estimate the code size
        let range = Z80_assemble.measureCodeSize(this.list);
        this.min_addr = range.min_addr;
        this.max_addr = range.min_addr;
    }

    /**
     * A binary code as assembling result.
     * @type {number[]}
     */
    this.buffer = null;

    if(!assembleOnly) {
        this.closeAssembling(this.label2value);
    }
};

/**
 * @returns {boolean} true if the source includes the ORG
 * pseudo mnemonic, otherwise false.
 */
Z80_assemble.prototype.isAddressExplicit = function() {
    return this._explicitAddress;
};


/**
 * Check the list having ORG pseudo mnemonic.
 *
 * @param {Array&lt;object>} assembleList
 * An array of line assembleled information.
 *
 * @returns {boolean} true the list includes ORG, otherwise false.
 */
Z80_assemble.hasExplicitAddress = function(assembleList) {
    for(let i = 0; i &lt; assembleList.length; i++) {
        if(assembleList[i].mnemonic === "ORG") {
            return true;
        }
    }
    return false;
};

/**
 * Resolve the relocatable addresses and create a machine code.
 *
 * @param {object} mapLabelToAddress
 * A dictionary to get address of the labels.
 *
 * @returns {undefined}
 */
Z80_assemble.prototype.closeAssembling = function(mapLabelToAddress) {

    // Resolve address references
    Z80_assemble.resolveAddress(this.list, mapLabelToAddress);

    // Estimate the code size
    let range = Z80_assemble.measureCodeSize(this.list);
    this.min_addr = range.min_addr;
    this.max_addr = range.min_addr;

    // Create machine code buffer
    this.buffer = Z80_assemble.createMachineCode(
        this.list, this.min_addr,
        this.max_addr - this.min_addr + 1);
};

/**
 * Resolve the undetermined addresses in the assembled list.
 *
 * @param {Array&lt;object>} assembleList
 * An array of line assembleled information.
 *
 * @param {object} mapLabelToAddress
 * A dictionary to get address of the labels.
 *
 * @returns {undefined}
 */
Z80_assemble.resolveAddress = function(assembleList, mapLabelToAddress) {
    assembleList.forEach( line => {
        line.resolveAddress(mapLabelToAddress);
    });
};

/**
 * Determine the addresses of first and last line.
 *
 * @param {Array&lt;object>} assembleList
 * An array of line assembleled information.
 *
 * @returns {object} that has min_addr and max_addr as keys.
 */
Z80_assemble.measureCodeSize = function(assembleList) {
    // address min-max
    let min_addr = null;
    let max_addr = null;
    assembleList.forEach(line => {
        if(line.bytecode.length > 0) {
            if(min_addr == null || line.address &lt; min_addr) {
                min_addr = line.address;
            }
            let lastAddr = line.getLastAddress();
            if(max_addr == null || lastAddr > max_addr) {
                max_addr = lastAddr;
            }
        }
    });
    return {
        min_addr: min_addr,
        max_addr: max_addr,
    };
};

/**
 * Create machine code from the assemble list.
 *
 * @param {Array&lt;object>} assembleList
 * An array of line assembleled information.
 *
 * @param {number} min_addr
 * The address of the first line of the list.
 *
 * @param {number} bytesize
 * The byte code size that simply determind from address.
 *
 * @returns {Array&lt;number>} that contains Z80 machine code.
 */
Z80_assemble.createMachineCode = function(assembleList, min_addr, bytesize) {
    let buffer = new Array(bytesize);
    assembleList.forEach(line => {
        if(line.bytecode.length > 0) {
            Array.prototype.splice.apply(buffer, [
                    line.address - min_addr,
                    line.bytecode.length
                ].concat(line.bytecode));
        }
    });
    return buffer;
};

/**
 * Assemble the sources.
 *
 * @param {Array&lt;string>} sources
 * Z80 assemble source
 *
 * @returns {object} as an assembled result.
 */
Z80_assemble.assemble = function(sources) {

    // Assemble each source
    let assembled = [];
    let startAddr = 0;
    let min_addr = null;
    let max_addr = null;
    let lastAddr = null;
    sources.forEach( src => {
        let asm = new Z80_assemble(src, true, startAddr);
        if(min_addr == null || min_addr > asm.min_addr) {
            min_addr = asm.min_addr;
        }
        if(max_addr == null || max_addr &lt; asm.max_addr) {
            max_addr = asm.max_addr;
        }
        let lineLastAddr = asm.list.slice(-1)[0].getNextAddress() - 1;
        if(lastAddr == null || lastAddr &lt; lineLastAddr) {
            lastAddr = lineLastAddr;
        }
        startAddr = lastAddr + 1;
        assembled.push(asm);
    });

    // Create an integrated address map
    let mapLabelToAddress = {};
    assembled.forEach( asm => {
        Object.keys(asm.label2value).forEach( label => {
            mapLabelToAddress[label] = asm.label2value[label];
        });
    });

    // Total code size
    assembled.forEach( asm => {
        asm.closeAssembling(mapLabelToAddress);
    });

    // Create machine code
    let buffer = new Array(lastAddr - min_addr + 1);
    for(let i = 0; i &lt; buffer.length; i++) {
        buffer[i] = 0;
    }
    assembled.forEach(asm => {
        if(asm.buffer.length > 0) {
            let last_addr = asm.max_addr + asm.buffer.length - 1;
            Array.prototype.splice.apply(buffer, [
                    asm.min_addr - min_addr,
                    last_addr - asm.min_addr + 1,
                ].concat(asm.buffer));
        }
    });

    return {
        obj: assembled,
        label2value: mapLabelToAddress,
        min_addr: min_addr,
        max_addr: max_addr,
        buffer: buffer,
    };
};

/**
 * Translate address string to value.
 * @param {string} addrToken
 * The address to be converted.
 * @returns {number} as the address.
 */
Z80_assemble.prototype.parseAddress = function(addrToken) {
    return parseAddress(addrToken, this.label2value);
};

/**
 * Returns a address map list.
 *
 * @description
 * Each element of the list is an object that has two fields 'label' and 'address'.
 * The list is sorted by the address.
 *
 * @returns {object[]} array of address map entry
 */
Z80_assemble.prototype.getMap = function() {
    return Z80_assemble.hashMapArray(this.label2value);
};

/**
 * Returns a address map list.
 *
 * @description
 * Each element of the list is an object that has two fields 'label' and 'address'.
 * The list is sorted by the address.
 *
 * @param {object} mapLabelToAddress
 * A dictionary to get address of the labels.
 *
 * @returns {object[]} array of address map entry
 */
Z80_assemble.hashMapArray = function(mapLabelToAddress) {
    return Object.keys(mapLabelToAddress).map(label => {
        return { "label": label, "address": mapLabelToAddress[label] };
    }).sort((a,b)=>{ return a.address - b.address; });
};

module.exports = Z80_assemble;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun May 20 2018 20:32:57 GMT+0900 (東京 (標準時)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
