<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MZ-700/mz700-emu-base.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmeditor.html">asmeditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#refresh">refresh</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmlist.html">asmlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#clearCurrentAddr">clearCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#indexOfAddr">indexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#lastLineIndexOfAddr">lastLineIndexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#setCurrentAddr">setCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#writeList">writeList</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="AsmRow.html">AsmRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AsmRow.html#.selectorByAddress">selectorByAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="dumplist.html">dumplist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#redraw">redraw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#topAddr">topAddr</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.html">mz700cg</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#.tableIndex">tableIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#createFontTable">createFontTable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#get">get</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#initFont">initFont</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="mz700cg.html#setPattern">setPattern</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="mz700cg.FontImage.html">FontImage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZ700Js.html">MZ700Js</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#cancelCtrlPanelTimeout">cancelCtrlPanelTimeout</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#createFullscreenButton">createFullscreenButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#createPublicMztLoadingButtons">createPublicMztLoadingButtons</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#createScreenKeyboardButton">createScreenKeyboardButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#hideCtrlPanel">hideCtrlPanel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#resizeScreen">resizeScreen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#setupControlPanel">setupControlPanel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#showCtrlPanel">showCtrlPanel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ700Js.html#toggleCtrlPanel">toggleCtrlPanel</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZ_MMIO.html">MZ_MMIO</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ_MMIO.html#entry">entry</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZ_MmioPeripheral.html">MZ_MmioPeripheral</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ_MmioPeripheral.html#readMMIO">readMMIO</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZ_MmioPeripheral.html#writeMMIO">writeMMIO</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZBeep.html">MZBeep</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#resume">resume</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#resumed">resumed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#setGain">setGain</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#startSound">startSound</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#stopSound">stopSound</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tabview.html">tabview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#.tabId">tabId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#caption">caption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#currentPage">currentPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#index">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#page">page</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#show">show</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ToggleButton.html">ToggleButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#off">off</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#on">on</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOff">setOff</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOn">setOn</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="vscrlist.html">vscrlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#_listTopIndex">_listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#countKeyRepeat">countKeyRepeat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#createList">createList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#empty">empty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#flashBufferedKeys">flashBufferedKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#isEmpty">isEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#items">items</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#listTopIndex">listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#reportKbEvent">reportKbEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scroll">scroll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scrollByKeyCode">scrollByKeyCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#setupKeyEventListener">setupKeyEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#syncScrollTop">syncScrollTop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#visibleRows">visibleRows</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80.html">Z80</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#disassemble">disassemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.dasm">dasm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80.html#.processAddressReference">processAddressReference</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80_assemble.html">Z80_assemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.assemble">assemble</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.createMachineCode">createMachineCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.hasExplicitAddress">hasExplicitAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.hashMapArray">hashMapArray</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.measureCodeSize">measureCodeSize</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#.resolveAddress">resolveAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#closeAssembling">closeAssembling</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#getMap">getMap</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#isAddressExplicit">isAddressExplicit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80_assemble.html#parseAddress">parseAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html">Z80AddressSpecifier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html#create">create</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80LineAssembler.html">Z80LineAssembler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.convertToAsciiCode">convertToAsciiCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.getBytecodesFromOperandOfDEFB">getBytecodesFromOperandOfDEFB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#.joinOperand">joinOperand</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getLastAddress">getLastAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#getNextAddress">getNextAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#resolveAddress">resolveAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setAddress">setAddress</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setComment">setComment</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setLabel">setLabel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80LineAssembler.html#setRefAddrTo">setRefAddrTo</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#doLater">doLater</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#easing">easing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEventCode">getEventCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#match_token">match_token</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseRequest">parseRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#requestJsonp">requestJsonp</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">MZ-700/mz700-emu-base.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global Uint8Array */
require("../lib/context.js");
require("../lib/ex_number.js");
const    TransWorker = require('transworker');
const   Z80_assemble = require("../Z80/assembler.js");
const  MZ_TapeHeader = require('./mz-tape-header.js');
const          MZ700 = require("./mz700.js");
const         MZBeep = require("./mz-beep.js");
const           MMIO = require("./mz-mmio.js");
const MZ700KeyMatrix = require("../MZ-700/mz700-key-matrix.js");
const        mz700cg = require("../lib/mz700-cg.js");
require("../lib/jquery.asmview.js");
require("../lib/jquery.asmlist.js");
require("../lib/jquery.tabview.js");
require("../lib/jquery.Z80-mem.js");
require("../lib/jquery.mz700-scrn.js");

const MZ700EmuBase = function() {
    this.opt = {
        urlPrefix: "",
        screenElement: null,
        mztDroppableElement: null,
        dataRecorderElement: null,
    };
    this.isRunning = false;
    this.scrn = null;
    this.sound = null;
    this.keyAcceptanceState = false;
    this.keystates = {};
};

MZ700EmuBase.prototype.create = async function(opt) {
    opt = opt || {};
    Object.keys(this.opt).forEach(function(key) {
        if(key in opt) {
            this.opt[key] = opt[key];
        }
    }, this);

    // Monoral buzzer sound
    this.sound = new MZBeep();

    // MZ-700 Screen
    if(this.opt.screenElement) {
        $(this.opt.screenElement).mz700scrn("create", {
            CG: new mz700cg(),
        });
        this.scrn = this.opt.screenElement["mz700scrn"];

        // Resume the AudioContext if it is suspended.
        let canvas = $(this.opt.screenElement).find("canvas");
        canvas.click(()=>{ this.allowToPlaySound(); });
        let title = canvas.attr("title");
        let checkSound = () => {
            if(!this.sound.resumed()) {
                canvas.attr("title",
                    "The Audio API is suspended by autoplay policy. " +
                    "To resume the sound, click here or volume controls.");
            } else {
                canvas.attr("title", title);
            }
        };
        this.sound.audio.addEventListener("statechange", event=>{
            event.stopPropagation();
            checkSound();
        });
        checkSound();
    }

    // Accept MZT file to drop to the MZ-700 screen
    if(this.opt.mztDroppableElement &amp;&amp;
        window.File &amp;&amp; window.FileReader &amp;&amp;
        window.FileList &amp;&amp; window.Blob)
    {
        let el = this.opt.mztDroppableElement;
        el.addEventListener('dragover', function(event) {
            event.stopPropagation();
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        }, false);
        el.addEventListener('drop', event => {
            event.stopPropagation();
            event.preventDefault();
            let files = event.dataTransfer.files; // FileList object.
            if(files.length > 0) {
                let f = files[0];
                let reader = new FileReader();
                reader.onload = async () => {
                    let tape_data = new Uint8Array(reader.result);
                    await this.setMztData(tape_data);
                };
                reader.readAsArrayBuffer(f);
            }
        }, false);
    }

    // Handle Key events
    let updateKeyStates = (event, state) => {
        let code = event.keyCode;
        if(!(code in this.keystates) || this.keystates[code] != state) {
            this.keystates[code] = state;
            let matrix = MZ700KeyMatrix.Code2Key[code];
            if(matrix != null) {
                let event = new Event("keyStateChanged");
                event.matrix = matrix;
                event.keyState = state;
                window.dispatchEvent(event);
                this.mz700comworker.setKeyState(
                    matrix.strobe, matrix.bit, state, null);
            }
        }
    };

    window.addEventListener("keydown", event => {
        if(this.keyAcceptanceState) {
            event.stopPropagation();
            updateKeyStates(event, true);
            return false;
        }
    });

    window.addEventListener("keyup", async event => {
        if(this.keyAcceptanceState) {
            event.stopPropagation();
            updateKeyStates(event, false);
            return false;
        }
    });

    //
    // Create MZ-700 Worker
    //

    this._mmio = MMIO.create();
    this.mz700comworker = TransWorker.create(
        this.opt.urlPrefix + "js/bundle-mz700-worker.js", MZ700, this, {
            'onExecutionParameterUpdate': param => {
                let event = new Event("emulationSpeedUpdated");
                event.timerInterval = param;
                window.dispatchEvent(event);
            },
            "start": () => {
                this.isRunning = true;
                window.dispatchEvent(new Event("mz700started"));
            },
            "stop": () => {
                this.isRunning = false;
                window.dispatchEvent(new Event("mz700stopped"));
            },
            "onNotifyClockFreq": clockCount => {
                $(".speed-control-slider").attr("title",
                    "Clock: " + (Math.round(100.0 * clockCount / 1000000) / 100) + " MHz");
            },
            'onBreak': () => {
                this.stop();
            },
            'onUpdateScreen': (this.scrn == null) ? () => {} :
                updateData => {
                    Object.keys(updateData).forEach(addr => {
                        let chr = updateData[addr];
                        this.scrn.writeVram(
                                addr, chr.attr, chr.dispcode);
                    });
                },
            'onMmioRead': param => {
                this._mmio.read(param.address, param.value);
            },
            'onMmioWrite': param => {
                this._mmio.write(param.address, param.value);
            },
            'onPortRead': ()=>{},
            'onPortWrite': ()=>{},
            'startSound': freq => { this.sound.startSound(freq[0]); },
            'stopSound': () => { this.sound.stopSound(); },
            "onStartDataRecorder": () => {
                window.dispatchEvent(new Event("onStartDataRecorder"));
            },
            "onStopDataRecorder": async ()=>{
                window.dispatchEvent(new Event("onStopDataRecorder"));
            }
        }
    );

    window.addEventListener("mz700started", () => {
        $(".MZ-700").addClass("running");
    });

    window.addEventListener("mz700stopped", () => {
        $(".MZ-700").removeClass("running");
    });

    //
    // Setup PCG-700
    //
    this.PCG700 = require("../lib/PCG-700").create();
    this.PCG700.writeMMIO(0xE010, 0x00);
    this.PCG700.writeMMIO(0xE011, 0x00);
    this.PCG700.writeMMIO(0xE012, 0x18);
    this.mmioMapPeripheral(this.PCG700, [], [0xE010, 0xE011, 0xE012]);
    window.addEventListener("enablePCG700", this.scrn == null ? ()=>{} : () => {
        this.scrn.changeCG(this.PCG700._cg);
        this.scrn.redraw();
    });
    window.addEventListener("disablePCG700", this.scrn == null ? ()=>{} : () => {
        this.scrn.restoreCG();
        this.scrn.redraw();
    });
    window.addEventListener("updatePCG700", this.scrn == null ? ()=>{} : event => {
        this.scrn.redrawChar(event.detail.atb, event.detail.dispCode);
    });

};

MZ700EmuBase.prototype.setEmuTimerInterval = function(timerInterval) {
    this.mz700comworker.setExecutionParameter(timerInterval, ()=>{});
};

MZ700EmuBase.prototype.mmioMapPeripheral = function(peripheral, mapToRead, mapToWrite) {
    this._mmio.entry(peripheral, mapToRead, mapToWrite);
    this.mz700comworker.mmioMapToRead(mapToRead, function(){});
    this.mz700comworker.mmioMapToWrite(mapToWrite, function(){});
};

MZ700EmuBase.prototype.reset = async function() {
    await this.stop();
    await new Promise( resolve => {
        this.mz700comworker.reset( () => {
            resolve();
        });
    });
    let bytes = await this.getCassetteTape();
    this.createCmtDownloadLink(bytes);
    await this.start(null);
};

MZ700EmuBase.prototype.start = function(addr) {
    return new Promise( async (resolve, reject) => {
        try {
            if(addr == null) {
                this.mz700comworker.start(() => {
                    resolve();
                });
            } else {
                await this.setPC(addr);
                this.mz700comworker.start(() => {
                    resolve();
                });
            }
        } catch(err) {
            reject(err);
        }
    });
};

MZ700EmuBase.prototype.stop = function() {
    return new Promise( (resolve, reject) => {
        this.mz700comworker.stop(() => {
            try {
                resolve();
            } catch(err) {
                reject(err);
            }
        });
    });
};

MZ700EmuBase.prototype.getRegister = function () {
    return new Promise( (resolve, reject) => {
        try {
            this.mz700comworker.getRegister(reg => {
                resolve(reg);
            });
        } catch(err) {
            reject(err);
        }
    });
};

/**
 *
 * Download and Run a MZT file that is placed on server.
 *
 * 1. Download MZT file from server as byte array.
 * 2. Load to the memory.
 * 3. Run.
 *
 * This is ASYNC function.
 *
 * @param {string} name MZT file's body name on the server
 * @returns {undefined}
 */
MZ700EmuBase.prototype.runServerMZT = async function (name) {
    await this.stop();
    $.getJSON("mzt/" + name + ".json", async tape_data => {
        await this.setMztData(tape_data);
    });
};

/**
 *
 * Load a MZT to the memory, and prepare to run.
 *
 * 1. Parse MZT's header area.
 * 2. Disassemble the MZT' body binary to assemble list.
 * 3. Assemble it back to the memory located by its header area.
 * 4. A program counter will be set to its execution address.
 *
 * @param {object} tape_data MZT tape data as byte array
 * @returns {undefined}
 */
MZ700EmuBase.prototype.setMztData = async function(tape_data) {
    await this.stop();
    await this.setCassetteTape(tape_data);
    if(tape_data != null) {
        let mztape_array = MZ700.parseMZT(tape_data);
        await this.loadCassetteTape();
        this.createCmtDownloadLink(tape_data);
        await this.disassemble(mztape_array);
        await this.start(mztape_array[0].header.addr_exec);
    }
};

MZ700EmuBase.prototype.disassemble = async function(mztape_array) {
    let name = MZ_TapeHeader.get1stFilename(mztape_array) || "(empty)";
    let result = MZ700.disassemble(mztape_array);
    if($(".source-list").length > 0) {
        $(".source-list").asmview("name", "mzt", name);
        this._asmlistMzt.asmlist("text", result.outbuf);
        this._asmlistMzt.asmlist("writeList",
            result.asmlist, await this.getBreakPoints());
    }
};

MZ700EmuBase.prototype.getBreakPoints = function() {
    return new Promise(resolve => {
        this.mz700comworker.getBreakPoints( breakpoints => {
            resolve(breakpoints);
        });
    });
};
MZ700EmuBase.prototype.acceptKey = function(state) {
    this.keyAcceptanceState = state;
    if(this.keyAcceptanceState) {
        window.dispatchEvent(new Event("keyinAcceptanceEnabled"));
    } else {
        window.dispatchEvent(new Event("keyinAcceptanceDisabled"));
    }
};

MZ700EmuBase.prototype.createCmtDownloadLink = function(bytes) {
    if(bytes == null || bytes.length &lt; 128) {
        this.cmtMessageArea.empty().append("(EMPTY)");
        return;
    }
    let header = new MZ_TapeHeader(bytes, 0);
    let byteArr = new Uint8Array(bytes);
    let blob = new Blob([byteArr], {'type': "application/octet-stream"});
    this.cmtMessageArea.empty().html(header.filename).append(
            $("&lt;a/>").addClass("download-link")
                .attr("download", header.filename + ".MZT")
                .attr("type", "application/octet-stream")
                .attr("href", URL.createObjectURL(blob))
                .html("")
                .attr("title",
                    "Download " + header.filename + ".MZT" +
                    " (" + header.file_size + " bytes) " +
                    " ADDR:(" + header.addr_load.HEX(4) + " - " +
                    (header.addr_load + header.file_size - 1).HEX(4) + ") EXEC:" +
                    header.addr_exec.HEX(4))
            );
}

/**
 * Assemble and display the list.
 * @async
 * @param {string} asmsrc
 * The source to be assemble with Z80 assembler.
 * @param {object} asmlist
 * jquery.asmlist object
 * @returns {Promise&lt;object>} as a result of assemble.
 */
MZ700EmuBase.prototype.assemble = async function( asmsrc, asmlist ) {
    let shouldBeResumed = this.isRunning;
    if(shouldBeResumed) {
        await this.stop();
    }
    let assembled = Z80_assemble.assemble([asmsrc]).obj[0];
    await this.writeAsmCode( assembled );
    asmlist.asmlist("writeList",
        assembled.list, await this.getBreakPoints());
    if(shouldBeResumed) {
        await this.start();
    }
    return assembled;
};
MZ700EmuBase.prototype.writeAsmCode = function(assembled) {
    return new Promise(resolve => {
        this.mz700comworker.writeAsmCode( assembled, execAddr => {
            resolve(execAddr);
        });
    });
};
MZ700EmuBase.prototype.setCassetteTape = function(tape_data) {
    return new Promise( resolve => {
        this.mz700comworker.setCassetteTape(tape_data, mztape_array => {
            resolve( mztape_array );
        });
    });
};
MZ700EmuBase.prototype.loadCassetteTape = function() {
    return new Promise( resolve => {
        this.mz700comworker.loadCassetteTape( () => { resolve(); });
    });
};
MZ700EmuBase.prototype.getCassetteTape = function() {
    return new Promise( resolve => {
        this.mz700comworker.getCassetteTape(bytes => {
            resolve(bytes);
        });
    });
};
MZ700EmuBase.prototype.setPC = function(addr) {
    return new Promise(resolve => {
        this.mz700comworker.setPC(addr, ()=>{
            resolve();
        });
    });
};
MZ700EmuBase.prototype.execute = function(steps) {
    return new Promise(resolve => {
        this.mz700comworker.exec(steps, ()=>{
            resolve();
        });
    });
};

MZ700EmuBase.prototype.allowToPlaySound = function() {
    if(!this.sound.resumed()) {
        this.sound.resume();
    }
};

module.exports = MZ700EmuBase;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Nov 17 2018 19:40:04 GMT+0900 (東京 (標準時)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
