<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/jquery-plugin/jquery.Z80-mem.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmeditor.html">asmeditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#refresh">refresh</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmlist.html">asmlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#clearCurrentAddr">clearCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#indexOfAddr">indexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#lastLineIndexOfAddr">lastLineIndexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#setCurrentAddr">setCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#writeList">writeList</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="AsmRow.html">AsmRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AsmRow.html#.selectorByAddress">selectorByAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="dumplist.html">dumplist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#redraw">redraw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#topAddr">topAddr</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tabview.html">tabview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#.tabId">tabId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#caption">caption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#currentPage">currentPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#index">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#page">page</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#show">show</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ToggleButton.html">ToggleButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#off">off</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#on">on</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOff">setOff</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOn">setOn</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#state">state</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#toggle">toggle</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="vscrlist.html">vscrlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#_listTopIndex">_listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#_maxTopRowIndex">_maxTopRowIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#countKeyRepeat">countKeyRepeat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#createList">createList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#empty">empty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#flashBufferedKeys">flashBufferedKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#isEmpty">isEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#items">items</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#listTopIndex">listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#reportKbEvent">reportKbEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scroll">scroll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scrollByKeyCode">scrollByKeyCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#setupKeyEventListener">setupKeyEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#syncScrollTop">syncScrollTop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#visibleRows">visibleRows</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html">Z80AddressSpecifier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html#create">create</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEventCode">getEventCode</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/jquery-plugin/jquery.Z80-mem.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const mz700charcode = require("../mz700-charcode.js");
const NumberUtil = require("../number-util.js");
var jquery_plugin_class = require("./jquery_plugin_class");

// Use "vscrlist" jQuery plugin
require("./jquery.vscrlist.js");

// Load jQuery plug-in Z80AddressSpecifier
require("./jquery.Z80-addr-spec.js");

jquery_plugin_class("dumplist");

/**
 * Hex dump list with MZ-700 characters.
 * @constructor
 *
 * @param {HTMLElement} element
 * A root element for this widget.
 */
var dumplist = function(element) {
    this.element = element;
    this.opt = {
        "mz700js": null,
        "cols" : 16,
        "rows" : 16,
        "_topAddr" : 0,
    };
    this._charViewAscii = true;
    this._topAddr = 0;
    this._topLeftAddr = 0;
    this.addrCols = [];
    this.dataCells = [];
    this._charViewRows = [];
    this._hexadumpRows = [];
};

window.dumplist = dumplist;

dumplist.charViewForeColor = 0;
dumplist.charViewBackColor = 7;
dumplist.charViewAttr =
    (dumplist.charViewForeColor &lt;&lt; 4) |
    dumplist.charViewBackColor;
dumplist.mz700CharSizePx = 10;

/**
 * Create
 *
 * @param {object} opt
 * An option parameter for this widget.
 *
 * @returns {undefined}
 */
dumplist.prototype.init = function(opt) {
    if(opt) {
        Object.keys(this.opt).forEach(function(key) {
            if(key in opt) { this.opt[key] = opt[key]; }
        }, this);
    }
    this._mz700js = this.opt.mz700js;

    var $root = $("&lt;div/>");
    $root.insertBefore($(this.element));
    $(this.element).appendTo($root);

    var $container = $(this.element);
    $container.addClass("dumplist");
    $container.empty();

    // Create header row
    let $headerRow = $("&lt;div/>").addClass("row").addClass("header");

    //Create row header column in header row
    var $col = $("&lt;span/>").addClass("cell").addClass("header")
        .html("ADDR");
    $headerRow.append($col);
    
    // Create each columns in header row
    for(var col = 0; col &lt; this.opt.cols; col++) {
        $col = $("&lt;span/>").addClass("cell").addClass("c" + col);
        $col.html('+' + NumberUtil.HEX(col, 1));
        $headerRow.append($col);
    }

    // Create a character view controls in header row
    let changeCharViewToAscii = showAscii => {
        if(this._charViewAscii != showAscii) {
            this._charViewAscii = showAscii;
            this.redraw();
        }
    };
    $headerRow.append($("&lt;span/>").addClass("char-selector")
        .append(
            $("&lt;input/>").attr("type", "radio").attr("name","charViewCode")
            .click(()=>{ changeCharViewToAscii(true); })
            .attr("checked", true))
        .append($("&lt;label/>").html("ASCII CODE"))
        .append($("&lt;span/>").html("/"))
        .append(
            $("&lt;input/>").attr("type", "radio").attr("name","charViewCode")
            .click(()=>{ changeCharViewToAscii(false); }))
        .append($("&lt;label/>").html("DISP.CODE")));

    // Create data rows
    for(var row = 0; row &lt; this.opt.rows; row++) {

        // Create data row
        let $row = $("&lt;div/>")
            .addClass("row").addClass("r" + row);

        $col = $("&lt;span/>").addClass("cell").addClass("header");

        $row.append($col);
        this.addrCols.push($col);

        // Create all columns in data row
        for(col = 0; col &lt; this.opt.cols; col++) {
            $col = $("&lt;span/>")
                .addClass("cell").addClass("c" + col);
            this.dataCells.push($col);
            $row.append($col);
        }
        const charViewRow = $("&lt;span/>").addClass("mz700chars").mz700scrn("create", {
            cols: this.opt.cols, rows:1,
            color: dumplist.charViewForeColor,
            backgroundColor: dumplist.charViewBackColor,
            width: (this.opt.cols * dumplist.mz700CharSizePx) + "px",
            alt:"", title:""
        }).mz700scrn("clear") .mz700scrn("setupRendering")
            .css("width", this.opt.cols * dumplist.mz700CharSizePx)
            .css("height", dumplist.mz700CharSizePx);
        $row.append(charViewRow);
        this._charViewRows.push(charViewRow);
        this._hexadumpRows.push($row);
    }

    // Create vscrlist's items
    let itemCount = 0x10000 / this.opt.cols;
    let listItems = new Array(itemCount);
    for(let i = 0; i &lt; itemCount; i++) {
        listItems[i] = {
            startAddr: i * this.opt.cols,
        };
    }

    // Create vscrlist widget
    this._hexdump = $("&lt;div/>").vscrlist("create", {
        rowHeight: 16, rowCount: this.opt.rows,
        keyRepeatBufferCount: 8,
        headerRow: $headerRow,
        createRow: index => {
            if(!this._hexdump || index &lt; 0 || listItems.length &lt;= index) {
                return;
            }
            let topItemIndex = this._hexdump.vscrlist("listTopIndex");
            let row = index - topItemIndex;

            let $row = this._hexadumpRows[row];
            let cellIndex = row * this.opt.cols;
            let addr = listItems[index].startAddr;
            this.addrCols[row].html( NumberUtil.HEX(addr, 4) );

            this._mz700js.readMemory(addr, addr + this.opt.cols).then(
                memblock => memblock.forEach( (value, col) => {
                    this.dataCells[cellIndex].html( NumberUtil.HEX(value, 2) );
                    if(this._charViewAscii) {
                        value = mz700charcode.ascii2dispcode[value];
                    }
                    this._charViewRows[row].mz700scrn(
                        "writeVram", col, dumplist.charViewAttr, value);
                    cellIndex++;
                })
            );
            return $row.get(0);
        }
    }).vscrlist("items", listItems)
    .on("scroll", () => {
        let topItemIndex = this._hexdump.vscrlist("listTopIndex");
        this._topLeftAddr = listItems[topItemIndex].startAddr;
    });
    $container.append(this._hexdump);
    this._hexdump.append(this._hexadumpRows).css("height", "280px");

    setTimeout(() => {
        this.topAddr(this.opt._topAddr);
    }, 0);
};

/**
 * Set top address and redraw.
 * @param {undefined|number} topAddr address to show. range: 0 to 65535.
 * @returns {number|undefined} top address
 */
dumplist.prototype.topAddr = function(topAddr) {
    if(topAddr == null) {
        return this._topAddr;
    }
    this._topAddr = topAddr;
    $("#txtShowMemAddr").val( NumberUtil.HEX(this._topAddr, 4) + "H" );

    // Calculate address at top-left
    var addr = this._topAddr - (this._topAddr % this.opt.cols) - 7 * this.opt.cols;
    let ulim = 65536 - this.opt.cols * this.opt.rows;
    if(addr > ulim) { addr = ulim; }
    if(addr &lt; 0) { addr = 0; }
    this._topLeftAddr = addr;
    let topItemIndex = this._topLeftAddr / this.opt.cols;
    this._hexdump.vscrlist("listTopIndex", topItemIndex);
};

/**
 * Redraw dumplist.
 *
 * @returns {undefined}
 */
dumplist.prototype.redraw = function() {

    let addr = this._topLeftAddr;
    this._mz700js.readMemory(addr, addr + this.opt.rows * this.opt.cols).then(
        memblock => {
            let i = 0;
            if(this._charViewAscii) {
                for(let row = 0; row &lt; this.opt.rows; row++) {
                    for(let col = 0; col &lt; this.opt.cols; col++) {
                        this._charViewRows[row].mz700scrn(
                            "writeVram", col, dumplist.charViewAttr,
                            mz700charcode.ascii2dispcode[memblock[i++]]);
                    }
                }
            } else {
                for(let row = 0; row &lt; this.opt.rows; row++) {
                    for(let col = 0; col &lt; this.opt.cols; col++) {
                        this._charViewRows[row].mz700scrn(
                            "writeVram", col, dumplist.charViewAttr,
                            memblock[i++]);
                    }
                }
            }
        }
    );
};

dumplist.prototype.addrSpecifier = function() {
    return $("&lt;div/>").Z80AddressSpecifier("create")
        .on("queryregister", async (event, regName, callback) => {
            const reg = await this._mz700js.getRegister();
            callback(reg[regName]);
        })
        .on("notifyaddress", (event, address) => {
            this.topAddr(address);
        });
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sat Jan 11 2020 21:08:39 GMT+0900 (GMT+09:00) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
