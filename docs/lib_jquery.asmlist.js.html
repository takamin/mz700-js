<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>lib/jquery.asmlist.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmeditor.html">asmeditor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#refresh">refresh</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmeditor.html#text">text</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="asmlist.html">asmlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#clearCurrentAddr">clearCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#indexOfAddr">indexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#lastLineIndexOfAddr">lastLineIndexOfAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#setCurrentAddr">setCurrentAddr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#text">text</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="asmlist.html#writeList">writeList</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="AsmRow.html">AsmRow</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AsmRow.html#.selectorByAddress">selectorByAddress</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="dumplist.html">dumplist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#redraw">redraw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="dumplist.html#topAddr">topAddr</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZBeep.html">MZBeep</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#resume">resume</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#resumed">resumed</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#setGain">setGain</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#startSound">startSound</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZBeep.html#stopSound">stopSound</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MZMMIO.html">MZMMIO</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZMMIO.html#read">read</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MZMMIO.html#write">write</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="tabview.html">tabview</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#.tabId">tabId</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#add">add</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#caption">caption</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#currentPage">currentPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#data">data</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#index">index</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#page">page</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabview.html#show">show</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ToggleButton.html">ToggleButton</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#off">off</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#on">on</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOff">setOff</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ToggleButton.html#setOn">setOn</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="vscrlist.html">vscrlist</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#_listTopIndex">_listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#countKeyRepeat">countKeyRepeat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#create">create</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#createList">createList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#empty">empty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#flashBufferedKeys">flashBufferedKeys</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#isEmpty">isEmpty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#items">items</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#listTopIndex">listTopIndex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#reportKbEvent">reportKbEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scroll">scroll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#scrollByKeyCode">scrollByKeyCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#setupKeyEventListener">setupKeyEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#syncScrollTop">syncScrollTop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="vscrlist.html#visibleRows">visibleRows</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html">Z80AddressSpecifier</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Z80AddressSpecifier.html#create">create</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#doLater">doLater</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#easing">easing</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEventCode">getEventCode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#requestJsonp">requestJsonp</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/jquery.asmlist.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

const jquery_plugin_class = require("../lib/jquery_plugin_class");
const NumberUtil = require("./number-util.js");

require("./jquery.tabview.js");
require("./jquery.vscrlist.js");
require("./jquery.asmeditor.js");

jquery_plugin_class("asmlist");

let ASMLIST_ROW_COUNT = 20;
let ASMLIST_ROW_HEIGHT = 13;

/**
 * asmlist jquery plug-in.
 * @constructor
 * @param {Element} element The DOM element
 */
function asmlist(element) {
    this._root = $(element);
    this._asm_list = [];
    this._currentAddr = null;
    this._breakpoints = {};
}

// Exports
window.asmlist = asmlist;
module.exports = asmlist;

/**
 * Create plug-in object.
 * @returns {undefined}
 */
asmlist.prototype.create = function() {
    if(!this._root.hasClass("asmlist")) {
        this._root.addClass("asmlist").tabview("create");
        this._scroller = $("&lt;div/>").vscrlist("create", {
            rowHeight: ASMLIST_ROW_HEIGHT,
            rowCount: ASMLIST_ROW_COUNT,
            createRow: index => {
                if(index > this._asm_list.length) {
                    return;
                }
                let asm_line = this._asm_list[index];
                let asmrow = new AsmRow(
                    asm_line, index + 1,
                    this._breakpoints[asm_line.address],
                    (event, addr, size, state) => {
                        size;
                        this._breakpoints[addr] = state;
                    },
                    rowSelector =>
                        this._scroller.vscrlist(
                            "visibleRows", rowSelector)
                );
                let curr_addr = this._currentAddr;
                if(curr_addr != null) {
                    if($(asmrow._dom).hasClass("pc" + NumberUtil.HEX(curr_addr, 4))) {
                        $(asmrow._dom).addClass("current");
                    }
                }
                return asmrow._dom;
            },
        }).addClass("assemble_list");

        // Create Assembled list (Debuggable)
        this._root
            .tabview("add", "asm",
                $("&lt;div/>").addClass("tabAsmList").append(this._scroller))
            .tabview("caption", "asm", "debug")
                .on("selected", () => {
                    if(this._scroller.vscrlist("isEmpty")) {
                        this._root.trigger("assemble", this.text());
                        this._root.tabview("caption", "src", "edit");
                    }
                });

        // Create Assembly source editor
        this._asmeditor = $("&lt;div/>").asmeditor("create")
                .on("change", (/*e*/) => {
                    this._scroller.vscrlist("empty");
                    this._root.tabview("caption", "src", "edit *");
                });
        this._root
            .tabview("add", "src", this._asmeditor)
            .tabview("caption", "src", "edit")
            .on("activated", () => {
                    this._asmeditor.asmeditor("refresh");
                });
    }
};

/**
 * Set assembly source text to textarea.
 *
 * @param {string} text (optional) The assembly source.
 * @returns {undefined|string}
 * Returns text if the text parameter is not specified.
 */
asmlist.prototype.text = function(text) {
    if(text == null) {
        return this._asmeditor.asmeditor("text");
    }
    this._asmeditor.asmeditor("text", text);
    this._root.tabview("caption", "src", "edit");
};

/**
 * Write assembled list
 * @param {object[]} asm_list An array of assembled row object.
 * @param {object} breakpoints
 * The breakpoint object mapping breakpoint status by address.
 * @returns {undefined}
 */
asmlist.prototype.writeList = function(asm_list, breakpoints) {
    this._asm_list = asm_list;
    this._breakpoints = breakpoints;
    this._scroller
        .vscrlist("items", this._asm_list)
        .vscrlist("listTopIndex", 0);
};
asmlist.prototype.loadAddr = function() {
    return this._asm_list[0].address;
};
asmlist.prototype.lastAddr = function() {
    for(let i = this._asm_list.length - 1; i >= 0; i--) {
        if(this._asm_list[i].bytecode.length > 0) {
            return this._asm_list[i].address + this._asm_list[i].bytecode.length - 1;
        }
    }
    return this._asm_list[0].address;
};

/**
 * AsmRow class.
 * DOM element as row of assemble list.
 * @constructor
 *
 * @param {object} asm_line An Assembled line object.
 * @param {number} rownum A row number.
 * @param {boolean} bp_state breakpoint status
 * @param {function} setbreak_handler A handler for setbreak event
 * @param {function} select_rows A handler to select rows
 */
function AsmRow(asm_line, rownum, bp_state, setbreak_handler, select_rows) {
    this._asmline = asm_line;
    let addr = this._asmline.address;
    let addr_hex = NumberUtil.HEX(addr, 4);
    let size = this._asmline.bytecode.length;
    let $row = $("&lt;div/>").addClass('row').addClass("pc" + addr_hex);

    $row.append($('&lt;span class="colRowAttr">&lt;/span>'))
        .append($('&lt;span class="colLineNumber">' + rownum + '&lt;/span>'))
        .append($('&lt;span class="colAddress">' + addr_hex + '&lt;/span>'))
        .append($('&lt;span class="colMachineCode">' +
            this._asmline.bytecode.map(c=>{return NumberUtil.HEX(c, 2);}).join("") +
            '&lt;/span>'));

    // label
    if(this._asmline.label != null) {
        $row.append($('&lt;span class="colLabel"/>')
                .html(this._asmline.label+':'));
    }

    // mnemonic
    if(this._asmline.mnemonic != null) {
        if(this._asmline.label == null) {
            $row.append($('&lt;span class="colLabel"> &lt;/span>'));
        }
        $row.append($('&lt;span class="colMnemonic"/>')
                .html(this._asmline.mnemonic))
            .append($('&lt;span class="colOperand"/>')
                .html(this._asmline.operand));
    }

    // comment
    $row.append($('&lt;span class="colComment"/>')
                .html((this._asmline.comment == null ?
                    ' ' : this._asmline.comment)));

    // breakpoint
    if(size > 0) {
        $row.attr("title",
                "Click to toggle a break point at $" + addr_hex + "H")
        .click(() => {
            let rows = select_rows(AsmRow.selectorByAddress(addr));
            if(rows.hasClass('breakPoint')) {
                $row.trigger("setbreak", [addr, size, false]);
                rows.removeClass('breakPoint');
            } else {
                $row.trigger("setbreak", [addr, size, true]);
                rows.addClass('breakPoint');
            }
        });
    }
    if(bp_state) {
        $row.addClass('breakPoint');
    }
    $row.on("setbreak", setbreak_handler);

    this._dom = $row.get(0);
}

/**
 * jQuery selector to select rows by address.
 * @param {number} addr The address
 * @return {string} jQuery selector
 */
AsmRow.selectorByAddress = function(addr) {
    return ".pc" + NumberUtil.HEX(addr, 4);
};

/**
 * Get first row index having the address.
 * @param {number} addr
 * Address to convert.
 * @returns {number}
 * returns row index.
 */
asmlist.prototype.indexOfAddr = function(addr) {
    for(let i = 0; i &lt; this._asm_list.length; i++) {
        if(this._asm_list[i].address == addr) {
            return i;
        }
    }
    return false;
};

/**
 * Get last row index having the address.
 * @param {number} addr
 * Address to convert.
 * @returns {number}
 * returns row index.
 */
asmlist.prototype.lastLineIndexOfAddr = function(addr) {
    let index = this.indexOfAddr(addr);
    let lastIndex = index;
    if(lastIndex !== false) {
        while(index &lt; this._asm_list.length) {
            if(this._asm_list[index].address == addr) {
                lastIndex = index;
                index++;
            } else {
                break;
            }
        }
    }
    return lastIndex;
}

/**
 * Set current program counter address and
 * show that line to the center of list with a style.
 * @param {number} addr The address to show center.
 * @returns {undefined}
 */
asmlist.prototype.setCurrentAddr = function(addr) {
    this.clearCurrentAddr();
    this._currentAddr = addr;
    let index = this.lastLineIndexOfAddr(this._currentAddr);
    if(index === false) {
        return;
    }
    this._scroller.vscrlist("listTopIndex",
        index - Math.floor(this._scroller.vscrlist("visibleRows").length / 2));

    this._scroller.vscrlist(
        "visibleRows", ".pc" + NumberUtil.HEX(this._currentAddr, 4)
    ).addClass("current");
};

/**
 * Clear the current program counter line style.
 * @returns {undefined}
 */
asmlist.prototype.clearCurrentAddr = function() {
    this._currentAddr = null;
    this._scroller
        .vscrlist("visibleRows", ".current")
        .removeClass("current");
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.2</a> on Wed Jun 19 2019 19:09:57 GMT+0900 (GMT+09:00) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
